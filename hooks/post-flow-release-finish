#!/bin/bash -xv

VERSION=$1
ROOTDIR=$(git rev-parse --show-toplevel)

echo "POST Flow release finish version: $VERSION $2 $3 $4"

FILE=composer.json

if [ -f $FILE ]; then

    TYPE=$(jq -r '.type' $FILE)
    NAME=$(jq -r '.name' $FILE)
    SLUG=$(basename $NAME)

    if [ "$TYPE" = "wordpress-plugin" ] || [ "$TYPE" = "wordpress-theme" ]; then

	# Create temporary dir

	TMPDIR=$(mktemp -d)
	mkdir -p $TMPDIR/$SLUG

	# Copy working tree to temporary dir

	cp -rf . $TMPDIR/$SLUG/

	# Remove vendor dir

	rm -rf $TMPDIR/$SLUG/vendor

	# Regenerate vendor dir excluding development dependencies

	composer install --working-dir $TMPDIR/$SLUG --no-interaction --no-dev --optimize-autoloader --quiet

	# Prepare distribution zip

	(
	    cd $TMPDIR
	    zip -9qr $ROOTDIR/../$SLUG.$VERSION.zip ./* \
		-x \
		$SLUG\*.git*\
		$SLUG\*.sass-cache*$ \
		$SLUG\.phpmd.xml \
		$SLUG\.bowerrc \
		$SLUG\*composer.* \
		$SLUG\components
	)

    fi

fi
